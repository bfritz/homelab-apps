apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
metadata:
  name: monitoring

resources:
  - github.com/bfritz/homelab-apps/vendor/kube-prometheus
  - ./alertmanager-email-brad.yaml
  - ./alertmanager-ingress.yaml
  - ./grafana-ingress.yaml
  - ./grafana-notifiers-brad.yaml
  - ./probes-key-public-ips.yaml
  - ./prometheus-ingress.yaml
  - ./prometheus_extra/additional-scrape-configs.yaml

images:
  - name: grafana/grafana
    newTag:
    digest: sha256:d6325d20f78cd306b4f8a9d0057ea7022a34d273553034d3d871040c3db37fc3 # 8.2.3 for linux/amd64

patches:
  - patch: |-
      apiVersion: monitoring.coreos.com/v1
      kind: Prometheus
      metadata:
        name: k8s
        namespace: monitoring
      spec:
        additionalScrapeConfigs:
          name: additional-scrape-configs
          key: prometheus-additional.yaml

  - patch: |-
      apiVersion: monitoring.coreos.com/v1
      kind: Alertmanager
      metadata:
        name: main
        namespace: monitoring
      spec:
        alertmanagerConfigSelector:
          matchLabels:
            alertmanagerConfig: active

  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: grafana
        namespace: monitoring
      spec:
        template:
          spec:
            containers:
            - name: grafana
              env:
              - name: GF_ANALYTICS_REPORTING_ENABLED
                value: "false"
              - name: GF_CHECK_FOR_UPDATES
                value: "false"
              - name: GF_UNIFIED_ALERTING_ENABLED
                value: "true"
              - name: GF_PLUGINS_ENABLE_ALPHA
                value: "true" # for AlertManager data source https://grafana.com/docs/grafana/latest/datasources/alertmanager/ @ v8.2
              - name: GF_ALERTING_ENABLED # legacy alerts
                value: "false"
              - name: GF_SMTP_ENABLED
                value: "true"
              - name: GF_SMTP_HOST
                value: mail.fewerhassles.com:587
              volumeMounts:
              - mountPath: /etc/grafana/provisioning/notifiers
                name: grafana-notifiers
                readOnly: false
            volumes:
            - name: grafana-notifiers
              configMap:
                name: grafana-notifiers-brad

  - path: blackbox-exporter-configuration.yaml
    target:
      name: blackbox-exporter-configuration
      kind: ConfigMap

  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: blackbox-exporter
        namespace: monitoring
      spec:
        template:
          spec:
            containers:
            - name: blackbox-exporter
              securityContext:
                runAsUser: 0 # to override the default of 65534 (nobody)
                runAsNonRoot: false
                capabilities:
                  drop: ["ALL"]
                  add: ["NET_RAW"]
